<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Production Dashboard</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--light-color);
      color: var(--primary-color);
      overflow: hidden;
    }
    .dashboard-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--secondary-color);
    }
    .title {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--primary-color);
    }
    .subtitle {
      font-size: 1.8rem;
      color: var(--secondary-color);
      font-weight: 500;
    }
    .date-time {
      text-align: right;
      font-size: 1.4rem;
    }
    .date {
      font-weight: bold;
    }
    .time {
      font-size: 1.8rem;
      margin-top: 5px;
    }
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .variant-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      background-color: var(--dark-color);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
    }
    .variant-name {
      font-size: 1.8rem;
      font-weight: bold;
    }
    .cycle-time {
      font-size: 1.8rem;
    }
    .chart-container {
      flex: 1;
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .hourly-data {
      display: flex;
      height: 100%;
    }
    .hour-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      padding: 0 10px;
      position: relative;
    }
    .hour-label {
      font-weight: bold;
      margin-top: 10px;
    }
    .bar-container {
      width: 80%;
      height: 85%;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
    }
    .target-line {
      position: absolute;
      width: 120%;
      border-top: 3px dashed var(--danger-color);
      font-weight: bold;
      color: var(--danger-color);
      text-align: right;
    }
    .target-label {
      position: absolute;
      top: -25px;
      right: -40px;
      color: var(--danger-color);
      font-weight: bold;
    }
    .bar {
      width: 100%;
      background-color: var(--secondary-color);
      border-radius: 5px 5px 0 0;
      position: relative;
      transition: height 1s ease;
    }
    .bar.above-target {
      background-color: var(--success-color);
    }
    .bar.below-target {
      background-color: var(--danger-color);
    }
    .bar-value {
      position: absolute;
      top: -25px;
      width: 100%;
      text-align: center;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .footer {
      margin-top: 20px;
      text-align: center;
      font-size: 1.2rem;
      color: var(--dark-color);
    }
    .progress-bar {
      height: 10px;
      background-color: var(--light-color);
      border-radius: 5px;
      margin-top: 10px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      background-color: var(--secondary-color);
      transition: width 0.5s linear;
      width: 0%;
    }
    .update-info {
      font-size: 0.8rem;
      color: var(--dark-color);
      text-align: right;
      margin-top: 5px;
    }
    .totals-display {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-size: 1.4rem;
    }
    .total-item {
      text-align: center;
      padding: 10px;
      background-color: var(--light-color);
      border-radius: 5px;
      min-width: 150px;
    }
    .total-label {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .total-value {
      font-size: 1.8rem;
    }
    .total-target {
      color: var(--danger-color);
    }
    .total-actual {
      color: var(--secondary-color);
    }
    .total-progress {
      color: var(--success-color);
    }
    .supervisor-filter {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }
    .supervisor-filter select {
      padding: 8px 12px;
      border-radius: 5px;
      border: 1px solid var(--secondary-color);
      font-size: 1rem;
      font-family: inherit;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="header">
      <div>
        <div class="title">Production Dashboard</div>
        <div class="subtitle">Medical Device Assembly</div>
      </div>
      <div class="date-time">
        <div class="date" id="current-date">Loading...</div>
        <div class="time" id="current-time">Loading...</div>
        <div class="update-info" id="last-update">Last updated: Never</div>
      </div>
    </div>
    <div class="supervisor-filter">
      <select id="supervisor-select">
        <option value="all">All Supervisors</option>
        <!-- Options will be added dynamically -->
      </select>
    </div>
    <div class="content">
      <div class="variant-info">
        <div class="variant-name" id="variant-name">Product Variant: Loading...</div>
        <div class="cycle-time" id="cycle-time">Target Cycle Time: Loading...</div>
      </div>
      <div class="totals-display" id="totals-display">
        <!-- Totals will be displayed here -->
      </div>
      <div class="chart-container">
        <div class="hourly-data" id="hourly-data">
          <!-- Hourly chart columns will be rendered here -->
        </div>
      </div>
    </div>
    <div class="footer">
      <div>Cycling through variants: <span id="current-variant-index">0</span>/<span id="total-variants">0</span></div>
      <div class="progress-bar">
        <div class="progress" id="cycle-progress"></div>
      </div>
    </div>
  </div>
  <script>
    // The fully calculated production data is passed from Apps Script.
    const productionData = JSON.parse('<?= productionData ?>');
    
    // Set initial state.
    let filteredVariants = productionData.variants || [];
    let currentVariantIndex = 0;
    let selectedSupervisor = 'all';
    
    function initDashboard() {
      updateDateTime();
      setInterval(updateDateTime, 1000);
      document.getElementById('supervisor-select').addEventListener('change', function() {
        selectedSupervisor = this.value;
        filterVariantsBySupervisor();
        currentVariantIndex = 0;
        if(filteredVariants.length > 0) displayVariant(0);
      });
      updateSupervisorDropdown();
      displayVariant(0);
      cycleVariants();
      animateProgress();
    }
    
    function updateDateTime() {
      const now = new Date();
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
      document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', {
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    function updateSupervisorDropdown() {
      const selectElement = document.getElementById('supervisor-select');
      while(selectElement.options.length > 1) {
        selectElement.remove(1);
      }
      if(productionData.supervisors && productionData.supervisors.length > 0) {
        productionData.supervisors.forEach(supervisor => {
          const option = document.createElement('option');
          option.value = supervisor.name;
          option.textContent = supervisor.name;
          selectElement.appendChild(option);
        });
      }
    }
    
    function filterVariantsBySupervisor() {
      if(selectedSupervisor === 'all') {
        filteredVariants = productionData.variants;
      } else {
        const supervisor = productionData.supervisors.find(s => s.name === selectedSupervisor);
        if(supervisor && supervisor.variants) {
          const supervisorVariantKeys = Object.keys(supervisor.variants);
          filteredVariants = productionData.variants.filter(variant => 
            supervisorVariantKeys.includes(variant.variant)
          );
        } else {
          filteredVariants = [];
        }
      }
      document.getElementById('total-variants').textContent = filteredVariants.length;
    }
    
    function displayVariant(index) {
      if(!filteredVariants || filteredVariants.length === 0) return;
      const variant = filteredVariants[index];
      document.getElementById('variant-name').textContent = `Product Variant: ${variant.variant}`;
      document.getElementById('cycle-time').textContent = `Target Cycle Time: ${variant.cycleTime} sec/unit`;
      document.getElementById('current-variant-index').textContent = (index + 1);
      updateTotalsDisplay(variant);
      createHourlyChart(variant);
    }
    
    function updateTotalsDisplay(variant) {
      const totalsDisplay = document.getElementById('totals-display');
      totalsDisplay.innerHTML = '';
      
      const totalActual = document.createElement('div');
      totalActual.className = 'total-item';
      totalActual.innerHTML = `<div class="total-label">Current Total</div>
        <div class="total-value total-actual">${variant.currentTotal || 0}</div>`;
      totalsDisplay.appendChild(totalActual);
      
      const totalTarget = document.createElement('div');
      totalTarget.className = 'total-item';
      totalTarget.innerHTML = `<div class="total-label">Daily Target</div>
        <div class="total-value total-target">${variant.dailyTarget || 0}</div>`;
      totalsDisplay.appendChild(totalTarget);
      
      const progress = variant.currentTotal && variant.dailyTarget ?
        Math.floor((variant.currentTotal / variant.dailyTarget) * 100) : 0;
      const totalProgress = document.createElement('div');
      totalProgress.className = 'total-item';
      totalProgress.innerHTML = `<div class="total-label">Progress</div>
        <div class="total-value total-progress">${progress}%</div>`;
      totalsDisplay.appendChild(totalProgress);
      
      if(variant.devicesPerBox) {
        const boxesCompleted = variant.currentBoxTotal || Math.floor(variant.currentTotal / variant.devicesPerBox);
        const totalBoxes = variant.dailyBoxTarget || Math.ceil(variant.dailyTarget / variant.devicesPerBox);
        const boxInfo = document.createElement('div');
        boxInfo.className = 'total-item';
        boxInfo.innerHTML = `<div class="total-label">Boxes</div>
          <div class="total-value">${boxesCompleted} / ${totalBoxes}</div>`;
        totalsDisplay.appendChild(boxInfo);
      }
    }
    
    function createHourlyChart(variant) {
      const chartContainer = document.getElementById('hourly-data');
      chartContainer.innerHTML = '';
      // Fixed hour range (7 AM to 7 PM)
      const startHour = 7;
      const endHour = 19;
      const maxValue = variant.chartScale;
      
      for(let i = startHour; i < endHour; i++) {
        const hourLabel = i < 10 ? `0${i}:00` : `${i}:00`;
        const hourDiv = document.createElement('div');
        hourDiv.className = 'hour-column';
        const barContainer = document.createElement('div');
        barContainer.className = 'bar-container';
        
        if(variant.hourlyTargetArray && variant.hourlyTargetArray[i]) {
          const targetLine = document.createElement('div');
          targetLine.className = 'target-line';
          targetLine.style.bottom = `${(variant.hourlyTargetArray[i] / maxValue) * 100}%`;
          const targetLabel = document.createElement('div');
          targetLabel.className = 'target-label';
          targetLabel.textContent = variant.hourlyTargetArray[i];
          targetLine.appendChild(targetLabel);
          barContainer.appendChild(targetLine);
        }
        
        const hourValue = variant.hourlyProduction[i] || 0;
        const hourTarget = (variant.hourlyTargetArray && variant.hourlyTargetArray[i]) || 0;
        
        const bar = document.createElement('div');
        bar.className = 'bar';
        if(hourValue >= hourTarget && hourTarget > 0) {
          bar.classList.add('above-target');
        } else if(hourValue > 0) {
          bar.classList.add('below-target');
        }
        bar.style.height = `${(hourValue / maxValue) * 100}%`;
        
        const barValue = document.createElement('div');
        barValue.className = 'bar-value';
        barValue.textContent = hourValue;
        bar.appendChild(barValue);
        
        barContainer.appendChild(bar);
        hourDiv.appendChild(barContainer);
        
        const hourLabelDiv = document.createElement('div');
        hourLabelDiv.className = 'hour-label';
        hourLabelDiv.textContent = hourLabel;
        hourDiv.appendChild(hourLabelDiv);
        
        chartContainer.appendChild(hourDiv);
      }
    }
    
    function cycleVariants() {
      if(!filteredVariants || filteredVariants.length === 0) return;
      currentVariantIndex = (currentVariantIndex + 1) % filteredVariants.length;
      displayVariant(currentVariantIndex);
      animateProgress();
    }
    
    function animateProgress() {
      let progress = 0;
      const interval = 100;
      const steps = 10000 / interval;
      const progressInterval = setInterval(() => {
        progress += (100 / steps);
        if(progress > 100) {
          progress = 100;
          clearInterval(progressInterval);
        }
        updateCycleProgress(progress);
      }, interval);
    }
    
    function updateCycleProgress(percent) {
      document.getElementById('cycle-progress').style.width = `${percent}%`;
    }
    
    window.onload = initDashboard;
  </script>
</body>
</html>
